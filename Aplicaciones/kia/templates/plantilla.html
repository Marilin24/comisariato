{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Comisariato Granados</title>

    <!-- Estilos base -->
    <link rel="stylesheet" href="{% static 'assets/vendors/mdi/css/materialdesignicons.min.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendors/css/vendor.bundle.base.css' %}" />
    <link rel="shortcut icon" href="{% static 'assets/images/favicon.png' %}" />

    <!-- Estilo personalizado -->
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        background-color: #e3f2fd;
        margin: 0;
        padding-top: 70px;
      }

      .navbar {
        background-color: #1565c0;
        color: white;
        padding: 15px 30px;
        position: fixed;
        width: 100%;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }

      .navbar a {
        color: white;
        margin: 0 10px;
        text-decoration: none;
        font-weight: bold;
        transition: 0.3s;
      }

      .navbar a:hover {
        color: #ffca28;
      }

      .main {
        padding: 40px 20px;
        max-width: 1200px;
        margin: auto;
      }

      .card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        padding: 30px;
        margin-bottom: 30px;
      }

      h2 {
        color: #1565c0;
        text-align: center;
      }

      h4 {
        color: #43a047;
      }

      .info-contacto li {
        margin-bottom: 10px;
        font-size: 16px;
      }

      .info-contacto i {
        margin-right: 8px;
        color: #1565c0;
      }

      footer {
        background-color: #1565c0;
        color: white;
        padding: 15px;
        text-align: center;
        font-size: 14px;
        margin-top: 40px;
      }

      .btn-comisariato {
        background-color: #ffca28;
        color: #212121;
        font-weight: bold;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        transition: 0.3s;
        cursor: pointer;
      }

      .btn-comisariato:hover {
        background-color: #fdd835;
      }

      .servicios {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        justify-content: center;
      }

      .servicio {
        flex: 1;
        min-width: 250px;
        background-color: #f1f8e9;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }

      .testimonios {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        justify-content: center;
      }

      .testimonio {
        flex: 1;
        min-width: 250px;
        background-color: #e8eaf6;
        padding: 20px;
        border-radius: 10px;
      }

      @media (max-width: 768px) {
        .navbar {
          flex-direction: column;
          align-items: flex-start;
        }

        .main {
          padding: 20px 10px;
        }
      }

      /* Estilos chatbot */

      #chatbot-toggle-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #1565c0;
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        font-size: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        transition: background-color 0.3s ease;
      }
      #chatbot-toggle-btn:hover {
        background-color: #0d3c75;
      }

      #chatbot-container {
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 350px;
        max-height: 500px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        display: none;
        flex-direction: column;
        overflow: hidden;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        z-index: 10001;
      }

      #chatbot-header {
        background-color: #1565c0;
        color: white;
        padding: 12px 16px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: grab;
        user-select: none;
      }
      #chatbot-header .close-btn {
        cursor: pointer;
        font-size: 20px;
        line-height: 1;
        transition: color 0.3s;
      }
      #chatbot-header .close-btn:hover {
        color: #ffca28;
      }

      #chat-history {
        padding: 15px;
        background-color: #fcfcfc;
        height: 350px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        scrollbar-width: thin;
        scrollbar-color: #ccc #f9f9f9;
      }

      .message {
        padding: 10px 15px;
        border-radius: 20px;
        margin: 8px 0;
        max-width: 75%;
        word-wrap: break-word;
        font-size: 14px;
        line-height: 1.4;
        display: inline-block;
      }

      .message.user {
        background-color: #e0f2f1;
        color: #00695c;
        align-self: flex-end;
        text-align: right;
        border: 1px solid #004d40;
      }

      .message.bot {
        background-color: #fff3e0;
        color: #ef6c00;
        align-self: flex-start;
        text-align: left;
        border: 1px solid #ffcc80;
      }

      .message.error {
        background-color: #ffebee;
        color: #b71c1c;
        border: 1px solid #f44336;
        font-weight: 600;
        text-align: center;
        max-width: 100%;
      }

      #input-area {
        display: flex;
        gap: 10px;
        padding: 12px 16px;
        border-top: 1px solid #ddd;
      }
      #input-area input[type="text"] {
        flex-grow: 1;
        padding: 10px 15px;
        border-radius: 25px;
        border: 1px solid #ccc;
        font-size: 14px;
        outline: none;
        transition: border-color 0.3s ease;
      }
      #input-area button {
        background-color: #ffca28;
        border: none;
        color: #212121;
        font-weight: bold;
        padding: 10px 18px;
        border-radius: 25px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      #input-area button:hover {
        background-color: #fdd835;
      }
    </style>
  </head>
  <body>
    <!-- NAVBAR -->
    <nav class="navbar">
      <div>
        <img src="{% static 'assets/images/images.jpeg' %}" alt="Logo Comisariato" height="40" />
      </div>
    </nav>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="main">
      <div class="card">
        <h2>Bienvenido al Comisariato Granados</h2>
        <p class="text-center">Conoce quiénes somos, qué hacemos y cómo te servimos</p>
        <div class="row" style="display: flex; flex-wrap: wrap; gap: 30px; justify-content: center;">
          <div style="flex: 1; min-width: 300px;">
            <img src="{% static 'assets/images/images.jpeg' %}" alt="Comisariato" class="img-fluid" style="width: 100%; border-radius: 10px;">
          </div>
          <div style="flex: 1; min-width: 300px;">
            <h4>¿Quiénes somos?</h4>
            <p>Somos una empresa familiar en Quito dedicada a ofrecer productos alimenticios, limpieza y cuidado personal de alta calidad a precios accesibles.</p>
            <h4>Misión</h4>
            <p>Proveer productos esenciales para el hogar con calidad, buen servicio y responsabilidad.</p>
            <h4>Visión</h4>
            <p>Ser el comisariato líder en Quito por su atención, variedad y precios competitivos.</p>
            <button class="btn-comisariato mt-3">Conócenos más</button>
          </div>
        </div>
      </div>

      <!-- Sección de Servicios -->
      <div class="card">
        <h4>Nuestros Servicios</h4>
        <div class="servicios">
          <div class="servicio">
            <i class="mdi mdi-cart"></i>
            <h5>Ventas al por menor</h5>
            <p>Amplia variedad de productos de consumo diario.</p>
          </div>
          <div class="servicio">
            <i class="mdi mdi-truck-delivery"></i>
            <h5>Entregas a domicilio</h5>
            <p>Servicio rápido y seguro hasta tu casa.</p>
          </div>
          <div class="servicio">
            <i class="mdi mdi-cash-register"></i>
            <h5>Atención personalizada</h5>
            <p>Te ayudamos a encontrar lo que necesitas.</p>
          </div>
        </div>
      </div>

      <!-- Testimonios -->
      <div class="card">
        <h4>Testimonios de clientes</h4>
        <div class="testimonios">
          <div class="testimonio">
            <p>"Excelente atención, siempre encuentro todo lo que necesito para mi hogar."</p>
            <strong>- Ana R.</strong>
          </div>
          <div class="testimonio">
            <p>"Los precios son muy buenos y el personal es amable."</p>
            <strong>- Carlos M.</strong>
          </div>
        </div>
      </div>

      <!-- Información de contacto -->
      <div class="card">
        <h4>Información de contacto</h4>
        <ul class="info-contacto list-unstyled">
          <li><i class="mdi mdi-map-marker"></i> Av. Granados y Av. Eloy Alfaro, Quito</li>
          <li><i class="mdi mdi-phone"></i> (02) 345 6789</li>
          <li><i class="mdi mdi-email"></i> info@comisariatogranados.com</li>
        </ul>
      </div>
    </div>

    <!-- FOOTER -->
    <footer>
      © 2025 Comisariato Granados | Diseñado con 💛 por estudiantes de la UTC
    </footer>

    <!-- Botón flotante para abrir chatbot -->
    <button id="chatbot-toggle-btn" aria-label="Abrir chatbot" title="Abrir chatbot">
      <i class="mdi mdi-robot"></i>
    </button>

    <!-- Contenedor chatbot flotante (oculto por defecto) -->
    <div id="chatbot-container" role="dialog" aria-modal="true" aria-labelledby="chatbot-header">
      <div id="chatbot-header">
        Chatbot Comisariato
        <span class="close-btn" role="button" aria-label="Cerrar chatbot" tabindex="0">&times;</span>
      </div>

      <div id="chat-history" aria-live="polite" aria-relevant="additions">
        <div class="message bot">
          👋 ¡Bienvenido/a al chatbot del comisariato! Puedes preguntarme por los productos más vendidos, el stock disponible o las ventas del día.
        </div>
      </div>

      <div id="input-area">
        <input type="text" id="userInput" placeholder="Escribe tu mensaje aquí..." aria-label="Escribe tu mensaje" autocomplete="off" />
        <button id="sendBtn" aria-label="Enviar mensaje">Enviar</button>
      </div>
    </div>

    <!-- Scripts base -->
    <script src="{% static 'assets/vendors/js/vendor.bundle.base.js' %}"></script>

    <!-- Script chatbot -->
    <script>
      // Obtener cookie CSRF para Django
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
      }

      // Mostrar mensaje en pantalla
      function showMessage(message, type) {
        const chatHistory = document.getElementById("chat-history");
        const div = document.createElement("div");

        div.className = `message ${type}`;
        div.style.padding = "10px 15px";
        div.style.borderRadius = "20px";
        div.style.margin = "8px 0";
        div.style.maxWidth = "75%";
        div.style.wordWrap = "break-word";
        div.style.fontSize = "14px";
        div.style.lineHeight = "1.4";
        div.style.display = "inline-block";

        if(type === "user") {
          div.style.backgroundColor = "#e0f2f1";
          div.style.color = "#00695c";
          div.style.alignSelf = "flex-end";
          div.style.textAlign = "right";
          div.style.border = "1px solid #004d40";
          div.innerHTML = `<strong>Tú:</strong> ${message.replace(/\n/g, "<br>")}`;
        } else if(type === "bot") {
          div.style.backgroundColor = "#fff3e0";
          div.style.color = "#ef6c00";
          div.style.alignSelf = "flex-start";
          div.style.textAlign = "left";
          div.style.border = "1px solid #ffcc80";
          div.innerHTML = `<strong>Chatbot:</strong> ${message.replace(/\n/g, "<br>")}`;
        } else if(type === "error") {
          div.style.backgroundColor = "#ffebee";
          div.style.color = "#b71c1c";
          div.style.border = "1px solid #f44336";
          div.style.fontWeight = "600";
          div.style.textAlign = "center";
          div.style.maxWidth = "100%";
          div.innerHTML = message;
        }

        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }

      // Mostrar "Pensando..."
      function showThinkingIndicator() {
        const chatHistory = document.getElementById("chat-history");
        const div = document.createElement("div");
        const id = "thinking-" + Date.now();

        div.id = id;
        div.className = "message thinking";
        div.style.fontStyle = "italic";
        div.style.color = "#757575";
        div.style.textAlign = "left";
        div.style.maxWidth = "100%";
        div.innerHTML = "<strong>Chatbot:</strong> <em>Pensando...</em>";

        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        return id;
      }

      // Quitar "Pensando..."
      function removeThinkingIndicator(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
      }

      // Enviar mensaje al backend
      async function sendMessage() {
        const userInput = document.getElementById("userInput");
        const userMessage = userInput.value.trim();

        if (!userMessage) {
          showMessage("Por favor escribe un mensaje", "error");
          return;
        }

        showMessage(userMessage, "user");

        const thinkingId = showThinkingIndicator();

        try {
          const response = await fetch("/api/chatbot/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({ message: userMessage }),
          });

          removeThinkingIndicator(thinkingId);

          if (!response.ok) {
            throw new Error(`Error ${response.status}: ${await response.text()}`);
          }

          const data = await response.json();

          if (data.respuesta_bot) {
            showMessage(data.respuesta_bot, "bot");
          } else if (data.error) {
            showMessage(`⚠️ ${data.error}`, "error");
          } else {
            throw new Error("Respuesta inesperada del servidor");
          }

        } catch (error) {
          console.error("Error:", error);
          removeThinkingIndicator(thinkingId);
          showMessage(`Error de conexión: ${error.message}`, "error");
        } finally {
          userInput.value = "";
          userInput.focus();
        }
      }

      // Mostrar chatbot
      function mostrarChatbot() {
        document.getElementById("chatbot-container").style.display = "flex";
        document.getElementById("chatbot-toggle-btn").style.display = "none";
        document.getElementById("userInput").focus();
      }

      // Ocultar chatbot
      function cerrarChatbot() {
        document.getElementById("chatbot-container").style.display = "none";
        document.getElementById("chatbot-toggle-btn").style.display = "flex";
      }

      // Eventos al cargar la página
      document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("sendBtn").addEventListener("click", sendMessage);
        document.getElementById("chatbot-toggle-btn").addEventListener("click", mostrarChatbot);
        document.querySelector("#chatbot-header .close-btn").addEventListener("click", cerrarChatbot);

        document.getElementById("userInput").addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
          }
        });
      });
    </script>
  </body>
</html>
